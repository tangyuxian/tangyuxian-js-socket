!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Socket=t()}(this,(function(){"use strict";function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function t(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}return function(){function o(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),n(this,"socketUrl",void 0),n(this,"option",void 0),n(this,"websocket",void 0),n(this,"sendPingInterval",void 0),n(this,"reconnectInterval",void 0),n(this,"activeLink",void 0),n(this,"reconnectNum",0),this.socketUrl=t,this.option=function(t){for(var o=1;o<arguments.length;o++){var i=null!=arguments[o]?arguments[o]:{};o%2?e(Object(i),!0).forEach((function(e){n(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):e(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({onOpenAutoSendMsg:"",heartTime:5e3,heartMsg:"ping",isReconnect:!0,reconnectTime:5e3,reconnectCount:-1,openCallback:null,closeCallback:null,messageCallback:null,errorCallback:null,debug:!1},i),this.websocket=null,this.sendPingInterval=null,this.reconnectInterval=null,this.activeLink=!0,this.reconnectNum=0,this.init()}var i,c,s;return i=o,(c=[{key:"init",value:function(){if(!("WebSocket"in window))throw new Error("当前浏览器不支持");if(!this.socketUrl)throw new Error("请配置连接地址");this.websocket=null,this.websocket=new WebSocket(this.socketUrl),this.websocketOnOpen(null),this.websocketOnMessage(null),this.websocketOnError(null),this.websocketOnClose(null)}},{key:"websocketOnOpen",value:function(e){var t=this;this.websocket instanceof WebSocket&&(this.websocket.onopen=function(n){t.option.debug&&console.log("%c websocket链接成功","color:green"),t.sendPing(t.option.heartTime,t.option.heartMsg),t.option.onOpenAutoSendMsg&&t.send(t.option.onOpenAutoSendMsg),"function"==typeof e?e(n):"function"==typeof t.option.openCallback&&t.option.openCallback(n)})}},{key:"send",value:function(e){this.websocket instanceof WebSocket&&this.websocket.readyState===this.websocket.OPEN&&this.websocket.send(e)}},{key:"websocketOnMessage",value:function(e){var t=this;this.websocket instanceof WebSocket&&(this.websocket.onmessage=function(n){"function"==typeof e?e(n.data):"function"==typeof t.option.messageCallback&&t.option.messageCallback(n.data)})}},{key:"websocketOnError",value:function(e){var t=this;this.websocket instanceof WebSocket&&(this.websocket.onerror=function(n){t.option.debug&&console.error("连接发生错误",n),"function"==typeof e?e(n):"function"==typeof t.option.errorCallback&&t.option.errorCallback(n)})}},{key:"websocketOnClose",value:function(e){var t=this;this.websocket instanceof WebSocket&&(this.websocket.onclose=function(n){t.option.debug&&console.warn("socket连接关闭,关于原因:",n),clearInterval(t.sendPingInterval),clearInterval(t.reconnectInterval),t.activeLink&&t.option.isReconnect?t.onReconnect():(t.activeLink=!1,t.option.debug&&console.log("%c websocket链接完全关闭","color:green")),"function"==typeof e?e(n):"function"==typeof t.option.closeCallback&&t.option.closeCallback(n)})}},{key:"onReconnect",value:function(){var e=this;this.option.debug&&console.warn("非正常关闭,".concat(this.option.reconnectTime,"毫秒后触发重连事件")),-1===this.option.reconnectCount||this.option.reconnectCount>this.reconnectNum?this.reconnectInterval=setTimeout((function(){e.reconnectNum++,e.option.debug&&console.warn("正在准备第".concat(e.reconnectNum,"次重连")),e.init()}),this.option.reconnectTime):(this.activeLink=!1,this.option.debug&&console.warn("已重连".concat(this.reconnectNum,"次仍然没有响应,取消重连")),clearInterval(this.reconnectInterval))}},{key:"removeSocket",value:function(){this.activeLink=!1,this.websocket instanceof WebSocket&&this.websocket.close(1e3)}},{key:"sendPing",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5e3,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"ping";clearInterval(this.sendPingInterval),-1!==t&&(this.send(n),this.sendPingInterval=setInterval((function(){e.send(n)}),t))}},{key:"getWebsocket",value:function(){return this.websocket}},{key:"getActiveLink",value:function(){return this.activeLink}}])&&t(i.prototype,c),s&&t(i,s),o}()}));
